<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reportes de Asistencia</title>
  <link rel="stylesheet" href="estilos.css">

  <!-- Evitar caché del navegador -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
</head>
<body>

  <img src="imagenes/logo1.png" alt="Logo" class="logo">

  <div class="contenedor" id="contenido" style="display: none;">
    <h2 class="titulo-modulo">Reportes de Asistencia</h2>
    <p class="bienvenida-usuario">Bienvenido, <span id="nombreUsuario"></span></p>

    <div class="tarjeta-reporte">
      <div class="filtros-reporte">
        <label for="fechaFiltro">Fecha:</label>
        <input type="date" id="fechaFiltro" autocomplete="off">

        <label for="gradoFiltro">Grado:</label>
        <select id="gradoFiltro" autocomplete="off">
          <option value="">Seleccione grado</option>
          <option value="Kinder">Kinder</option>
          <option value="Párvulos">Párvulos</option>
          <option value="Preparatoría">Preparatoría</option>
          <option value="1ro. Primaria">1ro. Primaria</option>
          <option value="2do. Primaria">2do. Primaria</option>
          <option value="3ro. Primaria">3ro. Primaria</option>
          <option value="4to. Primaria">4to. Primaria</option>
          <option value="5to. Primaria">5to. Primaria</option>
          <option value="6to. Primaria">6to. Primaria</option>
          <option value="1ro. Básico">1ro. Básico</option>
          <option value="2do. Básico">2do. Básico</option>
          <option value="3ro. Básico">3ro. Básico</option>
          <option value="4to. Computación">4to. Computación</option>
          <option value="5to. Computación">5to. Computación</option>
          <option value="4to. Dibujo Técnico">4to. Dibujo Técnico</option>
          <option value="5to. Dibujo Técnico">5to. Dibujo Técnico</option>
          <option value="4to. Ciencias y Letras">4to. Ciencias y Letras</option>
          <option value="5to. Ciencias y Letras">5to. Ciencias y Letras</option>
          <option value="4to. Perito Contador">4to. Perito Contador</option>
          <option value="5to. Perito Contador">5to. Perito Contador</option>
          <option value="6to. Perito Contador">6to. Perito Contador</option>
          <option value="4to. Administración">4to. Administración</option>
          <option value="5to. Administración">5to. Administración</option>
          <option value="6to. Administración">6to. Administración</option>
        </select>

        <button class="boton" onclick="filtrarReporte()">Filtrar</button>
        <label><input type="checkbox" id="soloAusentes" onchange="aplicarFiltroAusentes()" autocomplete="off"> Mostrar solo ausentes</label>
        <label><input type="checkbox" id="soloPresentes" onchange="aplicarFiltroPresentes()" autocomplete="off"> Mostrar solo presentes</label>
        <button class="boton" onclick="generarReporteGeneral()">Ver todos los ausentes</button>
      </div>

      <table class="tabla-reporte">
        <thead>
          <tr>
            <th>Alumno</th>
            <th>Grado</th>
            <th>Jornada</th>
            <th>Estado</th>
            <th>Hora</th>
            <th>Acceso</th>
          </tr>
        </thead>
        <tbody id="tablaAsistencia">
          <tr><td colspan="6" style="text-align:center;">Esperando datos...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="botones" style="margin-top: 30px;">
      <a href="index.html" class="boton">Volver al Menú</a>
      <a href="asistencia_login.html" onclick="cerrarSesion()" class="boton">Cerrar Sesión</a>
    </div>
  </div>

  <script>
    // ===========================
    // Configuración
    // ===========================
    const IDLE_MS = 60000; // 1 minuto (puedes ajustar el tiempo aquí)

    const usuario = sessionStorage.getItem("usuario");
    let datosCompletos = [];
    let idleTimer;

    if (!usuario) {
      window.location.href = "asistencia_login.html";
    } else {
      document.getElementById("nombreUsuario").textContent = usuario;
      document.getElementById("contenido").style.display = "block";
    }

    // Limpieza de datos/UI (sin romper tu lógica)
    function wipeData() {
      try { sessionStorage.removeItem("usuario"); } catch (e) {}

      datosCompletos = [];
      const tabla = document.getElementById("tablaAsistencia");
      if (tabla) {
        tabla.innerHTML = `<tr><td colspan="6" style="text-align:center;">Esperando datos...</td></tr>`;
      }
      const fecha = document.getElementById("fechaFiltro");
      const grado = document.getElementById("gradoFiltro");
      const chkA = document.getElementById("soloAusentes");
      const chkP = document.getElementById("soloPresentes");
      if (fecha) fecha.value = "";
      if (grado) grado.selectedIndex = 0;
      if (chkA) chkA.checked = false;
      if (chkP) chkP.checked = false;
    }

    function cerrarSesion() {
      sessionStorage.removeItem("usuario");
      wipeData();
    }

    async function filtrarReporte() {
      const fechaInput = document.getElementById("fechaFiltro").value;
      const grado = document.getElementById("gradoFiltro").value;
      const tabla = document.getElementById("tablaAsistencia");
      document.getElementById("soloAusentes").checked = false;
      document.getElementById("soloPresentes").checked = false;

      if (!fechaInput || !grado) {
        alert("Por favor seleccione una fecha y un grado.");
        return;
      }

      const fecha = new Date(fechaInput).toISOString().split("T")[0];
      tabla.innerHTML = `<tr><td colspan="6" style="text-align:center;">Cargando datos...</td></tr>`;

      try {
        const url = `https://script.google.com/macros/s/AKfycbz1oM7_ncBtZsm9TVxG3G3llcszY2xSJq2UbDK-0266cJIJnVfOdUsVmBD-u8zrMUXH/exec?fecha=${fecha}&grado=${encodeURIComponent(grado)}`;
        const respuesta = await fetch(url, { cache: "no-store" });
        const datos = await respuesta.json();

        if (!Array.isArray(datos)) {
          console.error("Error desde servidor:", datos.error || "Respuesta inesperada");
          tabla.innerHTML = `<tr><td colspan="6" style="text-align:center;">Error: ${datos.error || "Datos no válidos"}</td></tr>`;
          return;
        }

        datosCompletos = datos;
        mostrarDatosFiltrados(datos);
      } catch (error) {
        console.error("Error al cargar datos:", error);
        tabla.innerHTML = `<tr><td colspan="6" style="text-align:center;">No se pudo obtener la información.</td></tr>`;
      }
    }

    function aplicarFiltroAusentes() {
      document.getElementById("soloPresentes").checked = false;
      const datosFiltrados = datosCompletos.filter(d => d.estado === "Ausente");
      mostrarDatosFiltrados(datosFiltrados);
    }

    function aplicarFiltroPresentes() {
      document.getElementById("soloAusentes").checked = false;
      const datosFiltrados = datosCompletos.filter(d => d.estado === "Presente");
      mostrarDatosFiltrados(datosFiltrados);
    }

    function generarReporteGeneral() {
      const fechaInput = document.getElementById("fechaFiltro").value;
      if (!fechaInput) {
        alert("Por favor seleccione una fecha.");
        return;
      }
      const fecha = new Date(fechaInput).toISOString().split("T")[0];
      window.open(`reporte_ausentes_pdf.html?fecha=${fecha}`, "_blank");
    }

    function mostrarDatosFiltrados(datos) {
      const tabla = document.getElementById("tablaAsistencia");
      if (!Array.isArray(datos) || datos.length === 0) {
        tabla.innerHTML = `<tr><td colspan="6" style="text-align:center;">Sin resultados.</td></tr>`;
        return;
      }

      tabla.innerHTML = "";
      for (const fila of datos) {
        tabla.innerHTML += `
          <tr>
            <td>${fila.nombre}</td>
            <td>${fila.grado}</td>
            <td>${fila.jornada}</td>
            <td style="color:${fila.estado === 'Presente' ? 'green' : 'red'}; font-weight:bold">${fila.estado}</td>
            <td>${fila.hora ? new Date(fila.hora).toLocaleTimeString("es-ES", { hour: '2-digit', minute: '2-digit' }) : '—'}</td>
            <td>${fila.acceso || '—'}</td>
          </tr>
        `;
      }
    }

    // ---------------------------------------
    // INACTIVIDAD: regresar a index.html en IDLE_MS
    // ---------------------------------------
    function resetIdle() {
      clearTimeout(idleTimer);
      idleTimer = setTimeout(() => {
        wipeData();
        window.location.href = "index.html";
      }, IDLE_MS);
    }

    ["mousemove", "keydown", "click", "scroll", "touchstart"].forEach(evento => {
      document.addEventListener(evento, resetIdle, { passive: true });
    });
    resetIdle(); // iniciar temporizador al cargar

    // Limpiar datos si la pestaña se oculta o la página se cierra/recarga
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "hidden") {
        wipeData();
      }
    });
    window.addEventListener("beforeunload", () => {
      wipeData();
    });
  </script>

</body>
</html>
