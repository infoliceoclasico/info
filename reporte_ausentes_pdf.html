<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Exportar Ausentes a Excel</title>
  <link rel="stylesheet" href="estilos.css" />

  <!-- Evitar caché del navegador -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
</head>
<body>

  <!-- LOGO (misma referencia que tus otras páginas) -->
  <img src="imagenes/logo1.png" alt="Logo" class="logo" />

  <div class="contenedor" id="contenido">
    <h2 class="titulo-modulo">Exportar Ausentes a Excel</h2>
    <p class="bienvenida-usuario">Bienvenido, <span id="nombreUsuario"></span></p>

    <div class="tarjeta-reporte">
      <p class="instrucciones-form">
        Seleccione una fecha y el nivel para descargar el listado de ausentes.
      </p>

      <div class="filtros-reporte">
        <label for="fechaAusentesExcel">Fecha:</label>
        <input type="date" id="fechaAusentesExcel" autocomplete="off" />

        <button class="boton" type="button" onclick="limpiarFormulario()">Limpiar</button>
      </div>

      <!-- Botonera en 2 columnas con estilo del sistema -->
      <div class="grid-2columnas" style="padding: 10px 0 0 0;">
        <button class="boton-menu" type="button" onclick="exportarExcel('primaria_inicial')">
          Primaria Inicial
        </button>

        <button class="boton-menu" type="button" onclick="exportarExcel('primaria_alta')">
          Primaria Alta
        </button>

        <button class="boton-menu" type="button" onclick="exportarExcel('basicos')">
          Básicos
        </button>

        <button class="boton-menu" type="button" onclick="exportarExcel('bachilleratos')">
          Bachilleratos
        </button>

        <button class="boton-menu" type="button" onclick="exportarExcel('peritos')">
          Peritos
        </button>

        <button class="boton-menu" type="button" onclick="exportarExcel('general')">
          General
        </button>
      </div>
    </div>

    <div class="botones" style="margin-top: 30px;">
      <a href="index.html" class="boton-volver">Volver al Menú</a>
    </div>
  </div>

  <script>
    // ✅ Pega aquí la URL de tu Apps Script (doGet)
    // Debe responder descargando Excel y guardándolo en Drive
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyTPKN9lHWCXaFFzdbv2EQ7U275C8aWypmkvyQ-0G16Wb8T5gFoCvAdhSHtYWCH18zw/exec";

    // Seguridad / sesión (igual que el resto del sistema)
    const usuario = sessionStorage.getItem("usuario");
    if (!usuario) {
      window.location.href = "asistencia_login.html";
    } else {
      document.getElementById("nombreUsuario").textContent = usuario;
    }

    // Si viene fecha por parámetro en la URL, la coloca automáticamente
    const params = new URLSearchParams(window.location.search);
    const fechaParam = params.get("fecha");
    if (fechaParam) {
      document.getElementById("fechaAusentesExcel").value = fechaParam;
    }

    function limpiarFormulario() {
      document.getElementById("fechaAusentesExcel").value = "";
      // Limpia también parámetros en la URL si existen
      const urlLimpia = window.location.pathname;
      window.history.replaceState({}, document.title, urlLimpia);
    }

    function exportarExcel(nivel) {
      const fechaInput = document.getElementById("fechaAusentesExcel").value;

      if (!fechaInput) {
        alert("Por favor seleccione una fecha.");
        return;
      }

      // Formato YYYY-MM-DD (Apps Script suele trabajar mejor así)
      const fecha = new Date(fechaInput).toISOString().split("T")[0];

      // Llamada al Apps Script: descarga el Excel
      // nivel: primaria_inicial | primaria_alta | basicos | bachilleratos | peritos | general
      const url = `${SCRIPT_URL}?fecha=${encodeURIComponent(fecha)}&nivel=${encodeURIComponent(nivel)}`;

      // Dispara descarga (misma pestaña)
      window.location.href = url;
    }
  </script>
</body>
</html>
