<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Exportar Ausentes a Excel</title>
  <link rel="stylesheet" href="estilos.css">

  <!-- Evitar caché del navegador -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <style>
    /* Ajustes SOLO para este módulo (sin tocar tu estilos.css) */
    .grid-2columnas {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
      width: 100%;
      padding: 10px 20px 10px;
      box-sizing: border-box;
    }

    .grid-2columnas .boton-menu {
      width: 100%;
      display: block;
      padding: 18px 14px;
      border-radius: 12px;
    }

    /* Mensajes de estado */
    .estado-reporte {
      margin: 10px 20px 0;
      padding: 12px 14px;
      border-radius: 10px;
      font-weight: 600;
      display: none;
      box-sizing: border-box;
      text-align: center;
    }
    .estado-cargando {
      display: block;
      background: rgba(255, 193, 7, 0.18);
      border: 1px solid rgba(255, 193, 7, 0.45);
    }
    .estado-ok {
      display: block;
      background: rgba(40, 167, 69, 0.14);
      border: 1px solid rgba(40, 167, 69, 0.35);
    }
    .estado-error {
      display: block;
      background: rgba(220, 53, 69, 0.12);
      border: 1px solid rgba(220, 53, 69, 0.35);
    }

    /* Deshabilitar botones mientras genera */
    .btn-disabled {
      opacity: 0.65;
      pointer-events: none;
    }

    @media (max-width: 760px) {
      .grid-2columnas {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>

  <img src="imagenes/logo1.png" alt="Logo" class="logo">

  <div class="contenedor" id="contenido" style="display:none;">
    <h2 class="titulo-modulo">Exportar Ausentes a Excel</h2>
    <p class="bienvenida-usuario">Bienvenido, <span id="nombreUsuario"></span></p>

    <div class="tarjeta-reporte">
      <div class="filtros-reporte">
        <label for="fechaExcel">Fecha:</label>
        <input type="date" id="fechaExcel" autocomplete="off">
      </div>

      <!-- Mensaje de estado -->
      <div id="estado" class="estado-reporte"></div>

      <!-- Botones grandes (más estirados al ancho de la tarjeta) -->
      <div class="grid-2columnas">
        <button class="boton-menu" onclick="exportar('primaria_inicial')" id="btn_pi">Primaria Inicial</button>
        <button class="boton-menu" onclick="exportar('primaria_alta')" id="btn_pa">Primaria Alta</button>

        <button class="boton-menu" onclick="exportar('basicos')" id="btn_bas">Básicos</button>
        <button class="boton-menu" onclick="exportar('bachilleratos')" id="btn_bach">Bachilleratos</button>

        <button class="boton-menu" onclick="exportar('peritos')" id="btn_per">Peritos</button>
        <button class="boton-menu" onclick="exportar('general')" id="btn_gen">General</button>
      </div>
    </div>

    <!-- Barra inferior igual al sistema -->
    <div class="botones" style="margin-top: 30px;">
      <a href="index.html" class="boton">Volver al Menú</a>
      <a href="asistencia_login.html" onclick="cerrarSesion()" class="boton">Cerrar Sesión</a>
    </div>
  </div>

  <script>
    // ===========================
    // CONFIG: URL de tu Web App de exportación
    // ===========================
    const SCRIPT_EXPORT_URL = "https://script.google.com/macros/s/AKfycbwe2w4NsUVY1NPUJ2MsDTNkhGOdXUT790NmpwRPj9ccwgEm2jFudoB749RamGGRI73L/exec";

    const usuario = sessionStorage.getItem("usuario");

    if (!usuario) {
      window.location.href = "asistencia_login.html";
    } else {
      document.getElementById("nombreUsuario").textContent = usuario;
      document.getElementById("contenido").style.display = "block";
    }

    // Si viene fecha en la URL (?fecha=YYYY-MM-DD) la carga
    const params = new URLSearchParams(window.location.search);
    const fechaParam = params.get("fecha");
    if (fechaParam) {
      document.getElementById("fechaExcel").value = fechaParam;
    }

    function cerrarSesion() {
      sessionStorage.removeItem("usuario");
    }

    function setEstado(tipo, texto) {
      const el = document.getElementById("estado");
      el.className = "estado-reporte"; // reset
      el.textContent = texto;

      if (tipo === "cargando") el.classList.add("estado-cargando");
      if (tipo === "ok") el.classList.add("estado-ok");
      if (tipo === "error") el.classList.add("estado-error");

      el.style.display = "block";
    }

    function limpiarEstado() {
      const el = document.getElementById("estado");
      el.style.display = "none";
      el.textContent = "";
      el.className = "estado-reporte";
    }

    function setBotonesBloqueados(bloquear) {
      const botones = document.querySelectorAll(".boton-menu");
      botones.forEach(b => {
        if (bloquear) b.classList.add("btn-disabled");
        else b.classList.remove("btn-disabled");
      });
    }

    async function exportar(nivel) {
      limpiarEstado();

      const fechaInput = document.getElementById("fechaExcel").value;
      if (!fechaInput) {
        alert("Por favor seleccione una fecha.");
        return;
      }

      // ✅ NO convertir fecha a ISO (evita desfase por zona horaria)
      const fecha = fechaInput;

      const url = `${SCRIPT_EXPORT_URL}?fecha=${encodeURIComponent(fecha)}&nivel=${encodeURIComponent(nivel)}`;

      try {
        setBotonesBloqueados(true);
        setEstado("cargando", "Generando reporte...");

        const resp = await fetch(url, { cache: "no-store" });
        const data = await resp.json();

        if (data.status !== "ok") {
          setEstado("error", "Error al exportar: " + (data.mensaje || data.error || "Respuesta no válida"));
          setBotonesBloqueados(false);
          return;
        }

        // ✅ éxito
        setEstado("ok", "Reporte guardado");

        // Abre el archivo generado (descarga / vista)
        if (data.downloadUrl) {
          window.open(data.downloadUrl, "_blank");
        }

        setBotonesBloqueados(false);

      } catch (e) {
        console.error(e);
        setEstado("error", "No se pudo generar el Excel. Verifique su conexión o el Apps Script.");
        setBotonesBloqueados(false);
      }
    }
  </script>

</body>
</html>
