<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Exportar Ausentes</title>

  <!-- NO CACHE -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- TU CSS -->
  <link rel="stylesheet" href="estilos.css" />
</head>
<body>

  <div class="contenedor-reporte">
    <div class="tarjeta-reporte">

      <div class="encabezado-reporte">
        <h1>EXPORTAR AUSENTES A EXCEL</h1>
        <p>Seleccione una fecha y el nivel para descargar el listado de ausentes.</p>
      </div>

      <div class="filtros-reporte">
        <div class="grupo-filtro">
          <label for="fecha">FECHA</label>
          <input type="date" id="fecha" />
        </div>

        <div class="grupo-filtro" style="align-self: end;">
          <button class="btn-accion" id="btnLimpiar" type="button">LIMPIAR</button>
        </div>
      </div>

      <div class="acciones-reporte" style="display:grid; grid-template-columns: repeat(2, minmax(180px, 1fr)); gap: 12px;">
        <button class="btn-accion" type="button" data-nivel="primaria_inicial">PRIMARIA INICIAL</button>
        <button class="btn-accion" type="button" data-nivel="primaria_alta">PRIMARIA ALTA</button>
        <button class="btn-accion" type="button" data-nivel="basicos">BÁSICOS</button>
        <button class="btn-accion" type="button" data-nivel="bachilleratos">BACHILLERATOS</button>
        <button class="btn-accion" type="button" data-nivel="peritos">PERITOS</button>
        <button class="btn-accion" type="button" data-nivel="general">GENERAL</button>
      </div>

      <div class="seccion-resultado" style="margin-top: 16px;">
        <div id="estado" class="mensaje-reporte" style="display:none;"></div>
      </div>

      <div style="margin-top: 20px; display:flex; justify-content: space-between; gap: 10px; flex-wrap: wrap;">
        <button class="btn-secundario" type="button" id="btnRegresar">REGRESAR</button>
      </div>

    </div>
  </div>

<script>
  // ============================
  // SEGURIDAD / SESIÓN
  // ============================
  const usuario = sessionStorage.getItem("usuario");
  if (!usuario) {
    window.location.href = "login.html";
  }

  // ============================
  // CONFIG: pega tu URL de Apps Script aquí
  // ============================
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyTPKN9lHWCXaFFzdbv2EQ7U275C8aWypmkvyQ-0G16Wb8T5gFoCvAdhSHtYWCH18zw/exec";

  // ============================
  // UI HELPERS
  // ============================
  const estadoEl = document.getElementById("estado");
  const fechaEl = document.getElementById("fecha");

  function mostrarEstado(mensaje, tipo = "info") {
    estadoEl.style.display = "block";
    estadoEl.textContent = mensaje;

    // Opcional: si tu CSS tiene clases, puedes adaptarlo.
    // Aquí dejamos un estilo mínimo.
    estadoEl.style.padding = "10px";
    estadoEl.style.borderRadius = "8px";
    estadoEl.style.marginTop = "8px";

    if (tipo === "ok") {
      estadoEl.style.background = "#e7f7ee";
      estadoEl.style.color = "#0f5132";
      estadoEl.style.border = "1px solid #b7ebc6";
    } else if (tipo === "error") {
      estadoEl.style.background = "#fdecea";
      estadoEl.style.color = "#842029";
      estadoEl.style.border = "1px solid #f5c2c7";
    } else {
      estadoEl.style.background = "#eef3ff";
      estadoEl.style.color = "#1f2a44";
      estadoEl.style.border = "1px solid #cdd8ff";
    }
  }

  function ocultarEstado() {
    estadoEl.style.display = "none";
    estadoEl.textContent = "";
  }

  // ============================
  // FECHA: usar string directo (evita problemas de zona horaria)
  // ============================
  function obtenerFecha() {
    const f = (fechaEl.value || "").trim();
    return f; // YYYY-MM-DD
  }

  // ============================
  // DESCARGA AUTOMÁTICA
  // ============================
  function descargarArchivo(url, nombreSugerido) {
    const a = document.createElement("a");
    a.href = url;
    a.target = "_blank";
    a.rel = "noopener";

    // Algunos navegadores respetan download, otros no si es cross-origin,
    // pero igual abre el link directo de descarga.
    if (nombreSugerido) a.download = nombreSugerido;

    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  // ============================
  // LLAMADA AL APPS SCRIPT
  // ============================
  async function exportarExcel(nivel) {
    ocultarEstado();

    const fecha = obtenerFecha();
    if (!fecha) {
      mostrarEstado("Seleccione una fecha válida.", "error");
      return;
    }

    // UI: bloquear botones mientras genera
    const botones = document.querySelectorAll('button[data-nivel]');
    botones.forEach(b => b.disabled = true);

    try {
      mostrarEstado("Generando archivo Excel, por favor espere...", "info");

      const url = `${APPS_SCRIPT_URL}?fecha=${encodeURIComponent(fecha)}&nivel=${encodeURIComponent(nivel)}&formato=excel`;

      const res = await fetch(url, { cache: "no-store" });
      const data = await res.json();

      if (data.status !== "ok") {
        const msg = data.mensaje || data.error || "No se pudo generar el reporte.";
        mostrarEstado(msg, "error");
        return;
      }

      mostrarEstado(`Reporte generado. Ausentes: ${data.cantidad}. Iniciando descarga...`, "ok");

      if (data.downloadUrl) {
        descargarArchivo(data.downloadUrl, data.fileName || "");
      } else {
        // En caso extremo, al menos abrir la carpeta o algo
        mostrarEstado("Reporte generado, pero no se recibió URL de descarga.", "error");
      }

    } catch (err) {
      mostrarEstado("Error al conectar con el servidor. Verifique la URL del Apps Script y el despliegue.", "error");
    } finally {
      botones.forEach(b => b.disabled = false);
    }
  }

  // ============================
  // EVENTOS DE BOTONES
  // ============================
  document.querySelectorAll('button[data-nivel]').forEach(btn => {
    btn.addEventListener("click", () => exportarExcel(btn.dataset.nivel));
  });

  document.getElementById("btnLimpiar").addEventListener("click", () => {
    fechaEl.value = "";
    ocultarEstado();
  });

  document.getElementById("btnRegresar").addEventListener("click", () => {
    window.location.href = "reporte_asistencia.html";
  });

  // ============================
  // INACTIVIDAD (10 MIN)
  // ============================
  let inactivityTimer;
  function resetInactivity() {
    clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(() => {
      sessionStorage.clear();
      window.location.href = "login.html";
    }, 10 * 60 * 1000);
  }
  ["mousemove","keydown","click","scroll","touchstart"].forEach(evt => {
    window.addEventListener(evt, resetInactivity, { passive: true });
  });
  resetInactivity();

  // Si viene fecha por query (?fecha=YYYY-MM-DD), la coloca
  const params = new URLSearchParams(window.location.search);
  const f = params.get("fecha");
  if (f) fechaEl.value = f;

</script>
</body>
</html>
